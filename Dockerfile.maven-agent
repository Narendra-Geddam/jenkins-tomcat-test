# ---------------- Jenkins Maven Agent ----------------
FROM jenkins/inbound-agent:latest

USER root

# Install Java, Maven, and SSH client
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y openjdk-21-jdk maven openssh-client ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Set environment variables
ENV JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
ENV PATH=$JAVA_HOME/bin:$PATH

# Create .ssh directory and copy SSH key as root
RUN mkdir -p /home/jenkins/.ssh && chmod 700 /home/jenkins/.ssh
COPY tomcat_key /home/jenkins/.ssh/id_rsa

# Fix permissions and ownership
RUN chmod 600 /home/jenkins/.ssh/id_rsa && \
    chown -R jenkins:jenkins /home/jenkins/.ssh

# Switch to Jenkins user
USER jenkins
WORKDIR /home/jenkins

# Auto-generate known_hosts safely
RUN ssh-keyscan -H tomcat-server >> /home/jenkins/.ssh/known_hosts || echo "tomcat-server not reachable yet, skipping keyscan" && \
    chmod 644 /home/jenkins/.ssh/known_hosts

RUN echo "âœ… SSH setup complete for Maven agent."

WORKDIR /home/jenkins

